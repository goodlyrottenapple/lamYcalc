<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Theory FSet (Isabelle2016: February 2016)</title>
<link media="all" rel="stylesheet" type="text/css" href="isabelle.css"/>
</head>

<body>
<div class="head"><h1>Theory FSet</h1>

<span class="command">theory</span> <span class="name">FSet</span><br/>
<span class="keyword">imports</span> <a href="Multiset.html"><span class="name">Multiset</span></a> <a href="Quotient_List.html"><span class="name">Quotient_List</span></a><br/>

</div>
<div class="source">
<pre class="source"><span class="comment">(*  Title:      HOL/Quotient_Examples/FSet.thy
    Author:     Cezary Kaliszyk, TU Munich
    Author:     Christian Urban, TU Munich

Type of finite sets.
*)</span><span class="">
</span><span class="">
</span><span class="comment">(********************************************************************
  WARNING: There is a formalization of &#39;a fset as a subtype of sets in
  HOL/Library/FSet.thy using Lifting/Transfer. The user should use
  that file rather than this file unless there are some very specific
  reasons.
*********************************************************************)</span><span class="">
</span><span class="">
</span><span class="keyword1">theory</span><span class=""> </span><span class="">FSet</span><span class="">
</span><span class="keyword2">imports</span><span class=""> </span><span class="string">&quot;~~/src/HOL/Library/Multiset&quot;</span><span class=""> </span><span class="string">&quot;~~/src/HOL/Library/Quotient_List&quot;</span><span class="">
</span><span class="keyword2">begin</span><span class="">
</span><span class="">
</span><span class="keyword1">text</span><span class=""> </span><span class="verbatim">{* 
  The type of finite sets is created by a quotient construction
  over lists. The definition of the equivalence:
*}</span><span class="">
</span><span class="">
</span><span class="keyword1">definition</span><span class="">
</span><span class="">  </span><span class="">list_eq</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;&#39;a list &#8658; &#39;a list &#8658; bool&quot;</span><span class=""> </span><span class="delimiter">(</span><span class="keyword2">infix</span><span class=""> </span><span class="string">&quot;&#8776;&quot;</span><span class=""> </span><span class="">50</span><span class="delimiter">)</span><span class="">
</span><span class="keyword2">where</span><span class="">
</span><span class="">  </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;xs &#8776; ys &#10231; set xs = set ys&quot;</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">list_eq_reflp</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="string">&quot;reflp list_eq&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">intro</span><span class="delimiter">:</span><span class=""> </span><span class="">reflpI</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">list_eq_symp</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="string">&quot;symp list_eq&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">intro</span><span class="delimiter">:</span><span class=""> </span><span class="">sympI</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">list_eq_transp</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="string">&quot;transp list_eq&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">intro</span><span class="delimiter">:</span><span class=""> </span><span class="">transpI</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">list_eq_equivp</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="string">&quot;equivp list_eq&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">intro</span><span class="delimiter">:</span><span class=""> </span><span class="">equivpI</span><span class=""> </span><span class="">list_eq_reflp</span><span class=""> </span><span class="">list_eq_symp</span><span class=""> </span><span class="">list_eq_transp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">text</span><span class=""> </span><span class="verbatim">{* The @{text fset} type *}</span><span class="">
</span><span class="">
</span><span class="keyword1">quotient_type</span><span class="">
</span><span class="">  </span><span class="tfree">&#39;a</span><span class=""> </span><span class="">fset</span><span class=""> </span><span class="delimiter">=</span><span class=""> </span><span class="string">&quot;&#39;a list&quot;</span><span class=""> </span><span class="delimiter">/</span><span class=""> </span><span class="string">&quot;list_eq&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">list_eq_equivp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">text</span><span class=""> </span><span class="verbatim">{* 
  Definitions for sublist, cardinality, 
  intersection, difference and respectful fold over 
  lists.
*}</span><span class="">
</span><span class="">
</span><span class="keyword1">declare</span><span class=""> </span><span class="">List.member_def</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="">
</span><span class="">
</span><span class="keyword1">definition</span><span class="">
</span><span class="">  </span><span class="">sub_list</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;&#39;a list &#8658; &#39;a list &#8658; bool&quot;</span><span class="">
</span><span class="keyword2">where</span><span class=""> 
</span><span class="">  </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;sub_list xs ys &#10231; set xs &#8838; set ys&quot;</span><span class="">
</span><span class="">
</span><span class="keyword1">definition</span><span class="">
</span><span class="">  </span><span class="">card_list</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;&#39;a list &#8658; nat&quot;</span><span class="">
</span><span class="keyword2">where</span><span class="">
</span><span class="">  </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;card_list xs = card (set xs)&quot;</span><span class="">
</span><span class="">
</span><span class="keyword1">definition</span><span class="">
</span><span class="">  </span><span class="">inter_list</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;&#39;a list &#8658; &#39;a list &#8658; &#39;a list&quot;</span><span class="">
</span><span class="keyword2">where</span><span class="">
</span><span class="">  </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;inter_list xs ys = [x &#8592; xs. x &#8712; set xs &#8743; x &#8712; set ys]&quot;</span><span class="">
</span><span class="">
</span><span class="keyword1">definition</span><span class="">
</span><span class="">  </span><span class="">diff_list</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;&#39;a list &#8658; &#39;a list &#8658; &#39;a list&quot;</span><span class="">
</span><span class="keyword2">where</span><span class="">
</span><span class="">  </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;diff_list xs ys = [x &#8592; xs. x &#8713; set ys]&quot;</span><span class="">
</span><span class="">
</span><span class="keyword1">definition</span><span class="">
</span><span class="">  </span><span class="">rsp_fold</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;(&#39;a &#8658; &#39;b &#8658; &#39;b) &#8658; bool&quot;</span><span class="">
</span><span class="keyword2">where</span><span class="">
</span><span class="">  </span><span class="string">&quot;rsp_fold f &#10231; (&#8704;u v. f u &#8728; f v = f v &#8728; f u)&quot;</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">rsp_foldI</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="string">&quot;(&#8896;u v. f u &#8728; f v = f v &#8728; f u) &#10233; rsp_fold f&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">rsp_fold_def</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">rsp_foldE</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="string">&quot;rsp_fold f&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">obtains</span><span class=""> </span><span class="string">&quot;f u &#8728; f v = f v &#8728; f u&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">using</span><span class=""> </span><span class="">assms</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">rsp_fold_def</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">definition</span><span class="">
</span><span class="">  </span><span class="">fold_once</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;(&#39;a &#8658; &#39;b &#8658; &#39;b) &#8658; &#39;a list &#8658; &#39;b &#8658; &#39;b&quot;</span><span class="">
</span><span class="keyword2">where</span><span class="">
</span><span class="">  </span><span class="string">&quot;fold_once f xs = (if rsp_fold f then fold f (remdups xs) else id)&quot;</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">fold_once_default</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="string">&quot;&#172; rsp_fold f &#10233; fold_once f xs = id&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">fold_once_def</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">fold_once_fold_remdups</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="string">&quot;rsp_fold f &#10233; fold_once f xs = fold f (remdups xs)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">fold_once_def</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">section</span><span class=""> </span><span class="verbatim">{* Quotient composition lemmas *}</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">list_all2_refl&#39;</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="">q</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;equivp R&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;(list_all2 R) r r&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">list_all2_refl</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">metis</span><span class=""> </span><span class="">equivp_def</span><span class=""> </span><span class="">q</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">compose_list_refl</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="">q</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;equivp R&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;(list_all2 R OOO op &#8776;) r r&quot;</span><span class="">
</span><span class="keyword1">proof</span><span class="">
</span><span class="">  </span><span class="keyword1">have</span><span class=""> </span><span class="">*</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;r &#8776; r&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">equivp_reflp</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">fset_equivp</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;list_all2 R r r&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">list_all2_refl&#39;</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">q</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">with</span><span class=""> </span><span class="">*</span><span class=""> </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;(op &#8776; OO list_all2 R) r r&quot;</span><span class=""> </span><span class="keyword1">..</span><span class="">
</span><span class="keyword1">qed</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">map_list_eq_cong</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;b &#8776; ba &#10233; map f b &#8776; map f ba&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">only</span><span class="delimiter">:</span><span class=""> </span><span class="">list_eq_def</span><span class=""> </span><span class="">set_map</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">quotient_compose_list_g</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="">q</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;Quotient3 R Abs Rep&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class="">     </span><span class="">e</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;equivp R&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class="">  </span><span class="string">&quot;Quotient3 ((list_all2 R) OOO (op &#8776;))
    (abs_fset &#8728; (map Abs)) ((map Rep) &#8728; rep_fset)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">unfolding</span><span class=""> </span><span class="">Quotient3_def</span><span class=""> </span><span class="">comp_def</span><span class="">
</span><span class="keyword1">proof</span><span class=""> </span><span class="delimiter">(</span><span class="">intro</span><span class=""> </span><span class="">conjI</span><span class=""> </span><span class="">allI</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword3">fix</span><span class=""> </span><span class="">a</span><span class=""> </span><span class="">r</span><span class=""> </span><span class="">s</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;abs_fset (map Abs (map Rep (rep_fset a))) = a&quot;</span><span class="">
</span><span class="">    </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">abs_o_rep</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">q</span><span class="delimiter">]</span><span class=""> </span><span class="">Quotient3_abs_rep</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">Quotient3_fset</span><span class="delimiter">]</span><span class=""> </span><span class="">List.map.id</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">have</span><span class=""> </span><span class="">b</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;list_all2 R (map Rep (rep_fset a)) (map Rep (rep_fset a))&quot;</span><span class="">
</span><span class="">    </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">list_all2_refl&#39;</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">e</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">have</span><span class=""> </span><span class="">c</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;(op &#8776; OO list_all2 R) (map Rep (rep_fset a)) (map Rep (rep_fset a))&quot;</span><span class="">
</span><span class="">    </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class="delimiter">,</span><span class=""> </span><span class="">rule</span><span class=""> </span><span class="">equivp_reflp</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">fset_equivp</span><span class="delimiter">]</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">b</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;(list_all2 R OOO op &#8776;) (map Rep (rep_fset a)) (map Rep (rep_fset a))&quot;</span><span class="">
</span><span class="">    </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class="delimiter">,</span><span class=""> </span><span class="">rule</span><span class=""> </span><span class="">list_all2_refl&#39;</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">e</span><span class="delimiter">]</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">c</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;(list_all2 R OOO op &#8776;) r s = ((list_all2 R OOO op &#8776;) r r &#8743;
        (list_all2 R OOO op &#8776;) s s &#8743; abs_fset (map Abs r) = abs_fset (map Abs s))&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">proof</span><span class=""> </span><span class="delimiter">(</span><span class="">intro</span><span class=""> </span><span class="">iffI</span><span class=""> </span><span class="">conjI</span><span class="delimiter">)</span><span class="">
</span><span class="">    </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;(list_all2 R OOO op &#8776;) r r&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">compose_list_refl</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">e</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">    </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;(list_all2 R OOO op &#8776;) s s&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">compose_list_refl</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">e</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">next</span><span class="">
</span><span class="">    </span><span class="keyword3">assume</span><span class=""> </span><span class="">a</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;(list_all2 R OOO op &#8776;) r s&quot;</span><span class="">
</span><span class="">    </span><span class="keyword1">then</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="">b</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;map Abs r &#8776; map Abs s&quot;</span><span class="">
</span><span class="">    </span><span class="keyword1">proof</span><span class=""> </span><span class="delimiter">(</span><span class="">elim</span><span class=""> </span><span class="">relcomppE</span><span class="delimiter">)</span><span class="">
</span><span class="">      </span><span class="keyword3">fix</span><span class=""> </span><span class="">b</span><span class=""> </span><span class="">ba</span><span class="">
</span><span class="">      </span><span class="keyword3">assume</span><span class=""> </span><span class="">c</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;list_all2 R r b&quot;</span><span class="">
</span><span class="">      </span><span class="keyword3">assume</span><span class=""> </span><span class="">d</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;b &#8776; ba&quot;</span><span class="">
</span><span class="">      </span><span class="keyword3">assume</span><span class=""> </span><span class="">e</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;list_all2 R ba s&quot;</span><span class="">
</span><span class="">      </span><span class="keyword1">have</span><span class=""> </span><span class="">f</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;map Abs r = map Abs b&quot;</span><span class="">
</span><span class="">        </span><span class="keyword1">using</span><span class=""> </span><span class="">Quotient3_rel</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">list_quotient3</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">q</span><span class="delimiter">]</span><span class="delimiter">]</span><span class=""> </span><span class="">c</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">blast</span><span class="">
</span><span class="">      </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;map Abs ba = map Abs s&quot;</span><span class="">
</span><span class="">        </span><span class="keyword1">using</span><span class=""> </span><span class="">Quotient3_rel</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">list_quotient3</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">q</span><span class="delimiter">]</span><span class="delimiter">]</span><span class=""> </span><span class="">e</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">blast</span><span class="">
</span><span class="">      </span><span class="keyword1">then</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="">g</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;map Abs s = map Abs ba&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">      </span><span class="keyword1">then</span><span class=""> </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;map Abs r &#8776; map Abs s&quot;</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">d</span><span class=""> </span><span class="">f</span><span class=""> </span><span class="">map_list_eq_cong</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">    </span><span class="keyword1">qed</span><span class="">
</span><span class="">    </span><span class="keyword1">then</span><span class=""> </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;abs_fset (map Abs r) = abs_fset (map Abs s)&quot;</span><span class="">
</span><span class="">      </span><span class="keyword1">using</span><span class=""> </span><span class="">Quotient3_rel</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">Quotient3_fset</span><span class="delimiter">]</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">blast</span><span class="">
</span><span class="">  </span><span class="keyword1">next</span><span class="">
</span><span class="">    </span><span class="keyword3">assume</span><span class=""> </span><span class="">a</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;(list_all2 R OOO op &#8776;) r r &#8743; (list_all2 R OOO op &#8776;) s s
      &#8743; abs_fset (map Abs r) = abs_fset (map Abs s)&quot;</span><span class="">
</span><span class="">    </span><span class="keyword1">then</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="">s</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;(list_all2 R OOO op &#8776;) s s&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">    </span><span class="keyword1">have</span><span class=""> </span><span class="">d</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;map Abs r &#8776; map Abs s&quot;</span><span class="">
</span><span class="">      </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">subst</span><span class=""> </span><span class="">Quotient3_rel</span><span class=""> </span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">Quotient3_fset</span><span class="delimiter">,</span><span class=""> </span><span class="">symmetric</span><span class="delimiter">]</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">a</span><span class="delimiter">)</span><span class="">
</span><span class="">    </span><span class="keyword1">have</span><span class=""> </span><span class="">b</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;map Rep (map Abs r) &#8776; map Rep (map Abs s)&quot;</span><span class="">
</span><span class="">      </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">map_list_eq_cong</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">d</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">    </span><span class="keyword1">have</span><span class=""> </span><span class="">y</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;list_all2 R (map Rep (map Abs s)) s&quot;</span><span class="">
</span><span class="">      </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">fact</span><span class=""> </span><span class="">rep_abs_rsp_left</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">list_quotient3</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">q</span><span class="delimiter">]</span><span class="delimiter">,</span><span class=""> </span><span class="">OF</span><span class=""> </span><span class="">list_all2_refl&#39;</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">e</span><span class="delimiter">,</span><span class=""> </span><span class="">of</span><span class=""> </span><span class="">s</span><span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">    </span><span class="keyword1">have</span><span class=""> </span><span class="">c</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;(op &#8776; OO list_all2 R) (map Rep (map Abs r)) s&quot;</span><span class="">
</span><span class="">      </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">relcomppI</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">b</span><span class="delimiter">,</span><span class=""> </span><span class="">rule</span><span class=""> </span><span class="">y</span><span class="delimiter">)</span><span class="">
</span><span class="">    </span><span class="keyword1">have</span><span class=""> </span><span class="">z</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;list_all2 R r (map Rep (map Abs r))&quot;</span><span class="">
</span><span class="">      </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">fact</span><span class=""> </span><span class="">rep_abs_rsp</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">list_quotient3</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">q</span><span class="delimiter">]</span><span class="delimiter">,</span><span class=""> </span><span class="">OF</span><span class=""> </span><span class="">list_all2_refl&#39;</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">e</span><span class="delimiter">,</span><span class=""> </span><span class="">of</span><span class=""> </span><span class="">r</span><span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">    </span><span class="keyword1">then</span><span class=""> </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;(list_all2 R OOO op &#8776;) r s&quot;</span><span class="">
</span><span class="">      </span><span class="keyword1">using</span><span class=""> </span><span class="">a</span><span class=""> </span><span class="">c</span><span class=""> </span><span class="">relcomppI</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">  </span><span class="keyword1">qed</span><span class="">
</span><span class="keyword1">qed</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">quotient_compose_list</span><span class="delimiter">[</span><span class="">quot_thm</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class="">  </span><span class="string">&quot;Quotient3 ((list_all2 op &#8776;) OOO (op &#8776;))
    (abs_fset &#8728; (map abs_fset)) ((map rep_fset) &#8728; rep_fset)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">quotient_compose_list_g</span><span class="delimiter">,</span><span class=""> </span><span class="">rule</span><span class=""> </span><span class="">Quotient3_fset</span><span class="delimiter">,</span><span class=""> </span><span class="">rule</span><span class=""> </span><span class="">list_eq_equivp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">section</span><span class=""> </span><span class="verbatim">{* Quotient definitions for fsets *}</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">subsection</span><span class=""> </span><span class="verbatim">{* Finite sets are a bounded, distributive lattice with minus *}</span><span class="">
</span><span class="">
</span><span class="keyword1">instantiation</span><span class=""> </span><span class="">fset</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="delimiter">(</span><span class="">type</span><span class="delimiter">)</span><span class=""> </span><span class="string">&quot;{bounded_lattice_bot, distrib_lattice, minus}&quot;</span><span class="">
</span><span class="keyword2">begin</span><span class="">
</span><span class="">
</span><span class="keyword1">quotient_definition</span><span class="">
</span><span class="">  </span><span class="string">&quot;bot :: &#39;a fset&quot;</span><span class=""> 
</span><span class="">  </span><span class="keyword2">is</span><span class=""> </span><span class="string">&quot;Nil :: &#39;a list&quot;</span><span class=""> </span><span class="keyword1"><span class="improper">done</span></span><span class="">
</span><span class="">
</span><span class="keyword1">abbreviation</span><span class="">
</span><span class="">  </span><span class="">empty_fset</span><span class="">  </span><span class="delimiter">(</span><span class="string">&quot;{||}&quot;</span><span class="delimiter">)</span><span class="">
</span><span class="keyword2">where</span><span class="">
</span><span class="">  </span><span class="string">&quot;{||} &#8801; bot :: &#39;a fset&quot;</span><span class="">
</span><span class="">
</span><span class="keyword1">quotient_definition</span><span class="">
</span><span class="">  </span><span class="string">&quot;less_eq_fset :: (&#39;a fset &#8658; &#39;a fset &#8658; bool)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">is</span><span class=""> </span><span class="string">&quot;sub_list :: (&#39;a list &#8658; &#39;a list &#8658; bool)&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="keyword1">abbreviation</span><span class="">
</span><span class="">  </span><span class="">subset_fset</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;&#39;a fset &#8658; &#39;a fset &#8658; bool&quot;</span><span class=""> </span><span class="delimiter">(</span><span class="keyword2">infix</span><span class=""> </span><span class="string">&quot;|&#8838;|&quot;</span><span class=""> </span><span class="">50</span><span class="delimiter">)</span><span class="">
</span><span class="keyword2">where</span><span class="">
</span><span class="">  </span><span class="string">&quot;xs |&#8838;| ys &#8801; xs &#8804; ys&quot;</span><span class="">
</span><span class="">
</span><span class="keyword1">definition</span><span class="">
</span><span class="">  </span><span class="">less_fset</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;&#39;a fset &#8658; &#39;a fset &#8658; bool&quot;</span><span class="">
</span><span class="keyword2">where</span><span class="">  
</span><span class="">  </span><span class="string">&quot;xs &lt; ys &#8801; xs &#8804; ys &#8743; xs &#8800; (ys::&#39;a fset)&quot;</span><span class="">
</span><span class="">
</span><span class="keyword1">abbreviation</span><span class="">
</span><span class="">  </span><span class="">psubset_fset</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;&#39;a fset &#8658; &#39;a fset &#8658; bool&quot;</span><span class=""> </span><span class="delimiter">(</span><span class="keyword2">infix</span><span class=""> </span><span class="string">&quot;|&#8834;|&quot;</span><span class=""> </span><span class="">50</span><span class="delimiter">)</span><span class="">
</span><span class="keyword2">where</span><span class="">
</span><span class="">  </span><span class="string">&quot;xs |&#8834;| ys &#8801; xs &lt; ys&quot;</span><span class="">
</span><span class="">
</span><span class="keyword1">quotient_definition</span><span class="">
</span><span class="">  </span><span class="string">&quot;sup :: &#39;a fset &#8658; &#39;a fset &#8658; &#39;a fset&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">is</span><span class=""> </span><span class="string">&quot;append :: &#39;a list &#8658; &#39;a list &#8658; &#39;a list&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="keyword1">abbreviation</span><span class="">
</span><span class="">  </span><span class="">union_fset</span><span class=""> </span><span class="delimiter">(</span><span class="keyword2">infixl</span><span class=""> </span><span class="string">&quot;|&#8746;|&quot;</span><span class=""> </span><span class="">65</span><span class="delimiter">)</span><span class="">
</span><span class="keyword2">where</span><span class="">
</span><span class="">  </span><span class="string">&quot;xs |&#8746;| ys &#8801; sup xs (ys::&#39;a fset)&quot;</span><span class="">
</span><span class="">
</span><span class="keyword1">quotient_definition</span><span class="">
</span><span class="">  </span><span class="string">&quot;inf :: &#39;a fset &#8658; &#39;a fset &#8658; &#39;a fset&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">is</span><span class=""> </span><span class="string">&quot;inter_list :: &#39;a list &#8658; &#39;a list &#8658; &#39;a list&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="keyword1">abbreviation</span><span class="">
</span><span class="">  </span><span class="">inter_fset</span><span class=""> </span><span class="delimiter">(</span><span class="keyword2">infixl</span><span class=""> </span><span class="string">&quot;|&#8745;|&quot;</span><span class=""> </span><span class="">65</span><span class="delimiter">)</span><span class="">
</span><span class="keyword2">where</span><span class="">
</span><span class="">  </span><span class="string">&quot;xs |&#8745;| ys &#8801; inf xs (ys::&#39;a fset)&quot;</span><span class="">
</span><span class="">
</span><span class="keyword1">quotient_definition</span><span class="">
</span><span class="">  </span><span class="string">&quot;minus :: &#39;a fset &#8658; &#39;a fset &#8658; &#39;a fset&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">is</span><span class=""> </span><span class="string">&quot;diff_list :: &#39;a list &#8658; &#39;a list &#8658; &#39;a list&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">fastforce</span><span class="">
</span><span class="">
</span><span class="keyword1">instance</span><span class="">
</span><span class="keyword1">proof</span><span class="">
</span><span class="">  </span><span class="keyword3">fix</span><span class=""> </span><span class="">x</span><span class=""> </span><span class="">y</span><span class=""> </span><span class="">z</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;&#39;a fset&quot;</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;x |&#8834;| y &#10231; x |&#8838;| y &#8743; &#172; y |&#8838;| x&quot;</span><span class="">
</span><span class="">    </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">unfold</span><span class=""> </span><span class="">less_fset_def</span><span class="delimiter">,</span><span class=""> </span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;x |&#8838;| x&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;{||} |&#8838;| x&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;x |&#8838;| x |&#8746;| y&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;y |&#8838;| x |&#8746;| y&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;x |&#8745;| y |&#8838;| x&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;x |&#8745;| y |&#8838;| y&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;x |&#8746;| (y |&#8745;| z) = x |&#8746;| y |&#8745;| (x |&#8746;| z)&quot;</span><span class=""> 
</span><span class="">    </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="">
</span><span class="keyword1">next</span><span class="">
</span><span class="">  </span><span class="keyword3">fix</span><span class=""> </span><span class="">x</span><span class=""> </span><span class="">y</span><span class=""> </span><span class="">z</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;&#39;a fset&quot;</span><span class="">
</span><span class="">  </span><span class="keyword3">assume</span><span class=""> </span><span class="">a</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;x |&#8838;| y&quot;</span><span class="">
</span><span class="">  </span><span class="keyword3">assume</span><span class=""> </span><span class="">b</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;y |&#8838;| z&quot;</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;x |&#8838;| z&quot;</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">a</span><span class=""> </span><span class="">b</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="keyword1">next</span><span class="">
</span><span class="">  </span><span class="keyword3">fix</span><span class=""> </span><span class="">x</span><span class=""> </span><span class="">y</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;&#39;a fset&quot;</span><span class="">
</span><span class="">  </span><span class="keyword3">assume</span><span class=""> </span><span class="">a</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;x |&#8838;| y&quot;</span><span class="">
</span><span class="">  </span><span class="keyword3">assume</span><span class=""> </span><span class="">b</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;y |&#8838;| x&quot;</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;x = y&quot;</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">a</span><span class=""> </span><span class="">b</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="">
</span><span class="keyword1">next</span><span class="">
</span><span class="">  </span><span class="keyword3">fix</span><span class=""> </span><span class="">x</span><span class=""> </span><span class="">y</span><span class=""> </span><span class="">z</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;&#39;a fset&quot;</span><span class="">
</span><span class="">  </span><span class="keyword3">assume</span><span class=""> </span><span class="">a</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;y |&#8838;| x&quot;</span><span class="">
</span><span class="">  </span><span class="keyword3">assume</span><span class=""> </span><span class="">b</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;z |&#8838;| x&quot;</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;y |&#8746;| z |&#8838;| x&quot;</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">a</span><span class=""> </span><span class="">b</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="keyword1">next</span><span class="">
</span><span class="">  </span><span class="keyword3">fix</span><span class=""> </span><span class="">x</span><span class=""> </span><span class="">y</span><span class=""> </span><span class="">z</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;&#39;a fset&quot;</span><span class="">
</span><span class="">  </span><span class="keyword3">assume</span><span class=""> </span><span class="">a</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;x |&#8838;| y&quot;</span><span class="">
</span><span class="">  </span><span class="keyword3">assume</span><span class=""> </span><span class="">b</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;x |&#8838;| z&quot;</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;x |&#8838;| y |&#8745;| z&quot;</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">a</span><span class=""> </span><span class="">b</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="">
</span><span class="keyword1">qed</span><span class="">
</span><span class="">
</span><span class="keyword2">end</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">subsection</span><span class=""> </span><span class="verbatim">{* Other constants for fsets *}</span><span class="">
</span><span class="">
</span><span class="keyword1">quotient_definition</span><span class="">
</span><span class="">  </span><span class="string">&quot;insert_fset :: &#39;a &#8658; &#39;a fset &#8658; &#39;a fset&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">is</span><span class=""> </span><span class="string">&quot;Cons&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="">
</span><span class="keyword1">syntax</span><span class="">
</span><span class="">  </span><span class="string">&quot;_insert_fset&quot;</span><span class="">     </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;args =&gt; &#39;a fset&quot;</span><span class="">  </span><span class="delimiter">(</span><span class="string">&quot;{|(_)|}&quot;</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">translations</span><span class="">
</span><span class="">  </span><span class="string">&quot;{|x, xs|}&quot;</span><span class=""> </span><span class="delimiter">==</span><span class=""> </span><span class="string">&quot;CONST insert_fset x {|xs|}&quot;</span><span class="">
</span><span class="">  </span><span class="string">&quot;{|x|}&quot;</span><span class="">     </span><span class="delimiter">==</span><span class=""> </span><span class="string">&quot;CONST insert_fset x {||}&quot;</span><span class="">
</span><span class="">
</span><span class="keyword1">quotient_definition</span><span class="">
</span><span class="">  </span><span class="">fset_member</span><span class="">
</span><span class="keyword2">where</span><span class="">
</span><span class="">  </span><span class="string">&quot;fset_member :: &#39;a fset &#8658; &#39;a &#8658; bool&quot;</span><span class=""> </span><span class="keyword2">is</span><span class=""> </span><span class="string">&quot;List.member&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">fastforce</span><span class="">
</span><span class="">
</span><span class="keyword1">abbreviation</span><span class="">
</span><span class="">  </span><span class="">in_fset</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;&#39;a &#8658; &#39;a fset &#8658; bool&quot;</span><span class=""> </span><span class="delimiter">(</span><span class="keyword2">infix</span><span class=""> </span><span class="string">&quot;|&#8712;|&quot;</span><span class=""> </span><span class="">50</span><span class="delimiter">)</span><span class="">
</span><span class="keyword2">where</span><span class="">
</span><span class="">  </span><span class="string">&quot;x |&#8712;| S &#8801; fset_member S x&quot;</span><span class="">
</span><span class="">
</span><span class="keyword1">abbreviation</span><span class="">
</span><span class="">  </span><span class="">notin_fset</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;&#39;a &#8658; &#39;a fset &#8658; bool&quot;</span><span class=""> </span><span class="delimiter">(</span><span class="keyword2">infix</span><span class=""> </span><span class="string">&quot;|&#8713;|&quot;</span><span class=""> </span><span class="">50</span><span class="delimiter">)</span><span class="">
</span><span class="keyword2">where</span><span class="">
</span><span class="">  </span><span class="string">&quot;x |&#8713;| S &#8801; &#172; (x |&#8712;| S)&quot;</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">subsection</span><span class=""> </span><span class="verbatim">{* Other constants on the Quotient Type *}</span><span class="">
</span><span class="">
</span><span class="keyword1">quotient_definition</span><span class="">
</span><span class="">  </span><span class="string">&quot;card_fset :: &#39;a fset &#8658; nat&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">is</span><span class=""> </span><span class="">card_list</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="keyword1">quotient_definition</span><span class="">
</span><span class="">  </span><span class="string">&quot;map_fset :: (&#39;a &#8658; &#39;b) &#8658; &#39;a fset &#8658; &#39;b fset&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">is</span><span class=""> </span><span class="">map</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="keyword1">quotient_definition</span><span class="">
</span><span class="">  </span><span class="string">&quot;remove_fset :: &#39;a &#8658; &#39;a fset &#8658; &#39;a fset&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">is</span><span class=""> </span><span class="">removeAll</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="keyword1">quotient_definition</span><span class="">
</span><span class="">  </span><span class="string">&quot;fset :: &#39;a fset &#8658; &#39;a set&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">is</span><span class=""> </span><span class="string">&quot;set&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">fold_once_set_equiv</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="string">&quot;xs &#8776; ys&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;fold_once f xs = fold_once f ys&quot;</span><span class="">
</span><span class="keyword1">proof</span><span class=""> </span><span class="delimiter">(</span><span class="">cases</span><span class=""> </span><span class="string">&quot;rsp_fold f&quot;</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword3">case</span><span class=""> </span><span class="">False</span><span class=""> </span><span class="keyword1">then</span><span class=""> </span><span class="keyword3">show</span><span class=""> </span><span class="var">?thesis</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="keyword1">next</span><span class="">
</span><span class="">  </span><span class="keyword3">case</span><span class=""> </span><span class="">True</span><span class="">
</span><span class="">  </span><span class="keyword1">then</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;&#8896;x y. x &#8712; set (remdups xs) &#10233; y &#8712; set (remdups xs) &#10233; f x &#8728; f y = f y &#8728; f x&quot;</span><span class="">
</span><span class="">    </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">rsp_foldE</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">moreover</span><span class=""> </span><span class="keyword1">from</span><span class=""> </span><span class="">assms</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;mset (remdups xs) = mset (remdups ys)&quot;</span><span class="">
</span><span class="">    </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">set_eq_iff_mset_remdups_eq</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">ultimately</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;fold f (remdups xs) = fold f (remdups ys)&quot;</span><span class="">
</span><span class="">    </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">fold_multiset_equiv</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">with</span><span class=""> </span><span class="">True</span><span class=""> </span><span class="keyword3">show</span><span class=""> </span><span class="var">?thesis</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">fold_once_fold_remdups</span><span class="delimiter">)</span><span class="">
</span><span class="keyword1">qed</span><span class="">
</span><span class="">
</span><span class="keyword1">quotient_definition</span><span class="">
</span><span class="">  </span><span class="string">&quot;fold_fset :: (&#39;a &#8658; &#39;b &#8658; &#39;b) &#8658; &#39;a fset &#8658; &#39;b &#8658; &#39;b&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">is</span><span class=""> </span><span class="">fold_once</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">fold_once_set_equiv</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">concat_rsp_pre</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="">a</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;list_all2 op &#8776; x x&#39;&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class="">     </span><span class="">b</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;x&#39; &#8776; y&#39;&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class="">     </span><span class="">c</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;list_all2 op &#8776; y&#39; y&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class="">     </span><span class="">d</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;&#8707;x&#8712;set x. xa &#8712; set x&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;&#8707;x&#8712;set y. xa &#8712; set x&quot;</span><span class="">
</span><span class="keyword1">proof</span><span class=""> </span><span class="">-</span><span class="">
</span><span class="">  </span><span class="keyword3">obtain</span><span class=""> </span><span class="">xb</span><span class=""> </span><span class="keyword2">where</span><span class=""> </span><span class="">e</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;xb &#8712; set x&quot;</span><span class=""> </span><span class="keyword2">and</span><span class=""> </span><span class="">f</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;xa &#8712; set xb&quot;</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">d</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="">  </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;&#8707;y. y &#8712; set x&#39; &#8743; xb &#8776; y&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">list_all2_find_element</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">e</span><span class=""> </span><span class="">a</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">then</span><span class=""> </span><span class="keyword3">obtain</span><span class=""> </span><span class="">ya</span><span class=""> </span><span class="keyword2">where</span><span class=""> </span><span class="">h</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;ya &#8712; set x&#39;&quot;</span><span class=""> </span><span class="keyword2">and</span><span class=""> </span><span class="">i</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;xb &#8776; ya&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="">  </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;ya &#8712; set y&#39;&quot;</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">b</span><span class=""> </span><span class="">h</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">  </span><span class="keyword1">then</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;&#8707;yb. yb &#8712; set y &#8743; ya &#8776; yb&quot;</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">c</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">list_all2_find_element</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">then</span><span class=""> </span><span class="keyword3">show</span><span class=""> </span><span class="var">?thesis</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">f</span><span class=""> </span><span class="">i</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="keyword1">qed</span><span class="">
</span><span class="">
</span><span class="keyword1">quotient_definition</span><span class="">
</span><span class="">  </span><span class="string">&quot;concat_fset :: (&#39;a fset) fset &#8658; &#39;a fset&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">is</span><span class=""> </span><span class="">concat</span><span class=""> 
</span><span class="keyword1">proof</span><span class=""> </span><span class="delimiter">(</span><span class="">elim</span><span class=""> </span><span class="">relcomppE</span><span class="delimiter">)</span><span class="">
</span><span class="keyword3">fix</span><span class=""> </span><span class="">a</span><span class=""> </span><span class="">b</span><span class=""> </span><span class="">ba</span><span class=""> </span><span class="">bb</span><span class="">
</span><span class="">  </span><span class="keyword3">assume</span><span class=""> </span><span class="">a</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;list_all2 op &#8776; a ba&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">with</span><span class=""> </span><span class="">list_symp</span><span class=""> </span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">list_eq_symp</span><span class="delimiter">]</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="">a&#39;</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;list_all2 op &#8776; ba a&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">sympE</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword3">assume</span><span class=""> </span><span class="">b</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;ba &#8776; bb&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">with</span><span class=""> </span><span class="">list_eq_symp</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="">b&#39;</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;bb &#8776; ba&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">sympE</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword3">assume</span><span class=""> </span><span class="">c</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;list_all2 op &#8776; bb b&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">with</span><span class=""> </span><span class="">list_symp</span><span class=""> </span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">list_eq_symp</span><span class="delimiter">]</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="">c&#39;</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;list_all2 op &#8776; b bb&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">sympE</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;&#8704;x. (&#8707;xa&#8712;set a. x &#8712; set xa) = (&#8707;xa&#8712;set b. x &#8712; set xa)&quot;</span><span class=""> 
</span><span class="">  </span><span class="keyword1">proof</span><span class="">
</span><span class="">    </span><span class="keyword3">fix</span><span class=""> </span><span class="">x</span><span class="">
</span><span class="">    </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;(&#8707;xa&#8712;set a. x &#8712; set xa) = (&#8707;xa&#8712;set b. x &#8712; set xa)&quot;</span><span class=""> 
</span><span class="">    </span><span class="keyword1">proof</span><span class="">
</span><span class="">      </span><span class="keyword3">assume</span><span class=""> </span><span class="">d</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;&#8707;xa&#8712;set a. x &#8712; set xa&quot;</span><span class="">
</span><span class="">      </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;&#8707;xa&#8712;set b. x &#8712; set xa&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">concat_rsp_pre</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">a</span><span class=""> </span><span class="">b</span><span class=""> </span><span class="">c</span><span class=""> </span><span class="">d</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">    </span><span class="keyword1">next</span><span class="">
</span><span class="">      </span><span class="keyword3">assume</span><span class=""> </span><span class="">e</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;&#8707;xa&#8712;set b. x &#8712; set xa&quot;</span><span class="">
</span><span class="">      </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;&#8707;xa&#8712;set a. x &#8712; set xa&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">concat_rsp_pre</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">c&#39;</span><span class=""> </span><span class="">b&#39;</span><span class=""> </span><span class="">a&#39;</span><span class=""> </span><span class="">e</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">    </span><span class="keyword1">qed</span><span class="">
</span><span class="">  </span><span class="keyword1">qed</span><span class="">
</span><span class="">  </span><span class="keyword1">then</span><span class=""> </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;concat a &#8776; concat b&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="keyword1">qed</span><span class="">
</span><span class="">
</span><span class="keyword1">quotient_definition</span><span class="">
</span><span class="">  </span><span class="string">&quot;filter_fset :: (&#39;a &#8658; bool) &#8658; &#39;a fset &#8658; &#39;a fset&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">is</span><span class=""> </span><span class="">filter</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">force</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">subsection</span><span class=""> </span><span class="verbatim">{* Compositional respectfulness and preservation lemmas *}</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">Nil_rsp2</span><span class=""> </span><span class="delimiter">[</span><span class="">quot_respect</span><span class="delimiter">]</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;(list_all2 op &#8776; OOO op &#8776;) Nil Nil&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">compose_list_refl</span><span class="delimiter">,</span><span class=""> </span><span class="">rule</span><span class=""> </span><span class="">list_eq_equivp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">Cons_rsp2</span><span class=""> </span><span class="delimiter">[</span><span class="">quot_respect</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;(op &#8776; ===&gt; list_all2 op &#8776; OOO op &#8776; ===&gt; list_all2 op &#8776; OOO op &#8776;) Cons Cons&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">intro</span><span class="delimiter">!</span><span class="delimiter">:</span><span class=""> </span><span class="">rel_funI</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">rule_tac</span><span class=""> </span><span class="">b</span><span class="delimiter">=</span><span class="string">&quot;x # b&quot;</span><span class=""> </span><span class="keyword2">in</span><span class=""> </span><span class="">relcomppI</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">rule_tac</span><span class=""> </span><span class="">b</span><span class="delimiter">=</span><span class="string">&quot;x # ba&quot;</span><span class=""> </span><span class="keyword2">in</span><span class=""> </span><span class="">relcomppI</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">done</span></span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">Nil_prs2</span><span class=""> </span><span class="delimiter">[</span><span class="">quot_preserve</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="string">&quot;Quotient3 R Abs Rep&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;(Abs &#8728; map f) [] = Abs []&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">Cons_prs2</span><span class=""> </span><span class="delimiter">[</span><span class="">quot_preserve</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="">q</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;Quotient3 R1 Abs1 Rep1&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class="">     </span><span class="">r</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;Quotient3 R2 Abs2 Rep2&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;(Rep1 ---&gt; (map Rep1 &#8728; Rep2) ---&gt; (Abs2 &#8728; map Abs1)) (op #) = (id ---&gt; Rep2 ---&gt; Abs2) (op #)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">fun_eq_iff</span><span class=""> </span><span class="">comp_def</span><span class=""> </span><span class="">Quotient3_abs_rep</span><span class=""> </span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">q</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">append_prs2</span><span class=""> </span><span class="delimiter">[</span><span class="">quot_preserve</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="">q</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;Quotient3 R1 Abs1 Rep1&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class="">     </span><span class="">r</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;Quotient3 R2 Abs2 Rep2&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;((map Rep1 &#8728; Rep2) ---&gt; (map Rep1 &#8728; Rep2) ---&gt; (Abs2 &#8728; map Abs1)) op @ =
    (Rep2 ---&gt; Rep2 ---&gt; Abs2) op @&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">fun_eq_iff</span><span class=""> </span><span class="">abs_o_rep</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">q</span><span class="delimiter">]</span><span class=""> </span><span class="">List.map.id</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">list_all2_app_l</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="">a</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;reflp R&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class=""> </span><span class="">b</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;list_all2 R l r&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;list_all2 R (z @ l) (z @ r)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">using</span><span class=""> </span><span class="">a</span><span class=""> </span><span class="">b</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">induct</span><span class=""> </span><span class="">z</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">elim</span><span class="delimiter">:</span><span class=""> </span><span class="">reflpE</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">append_rsp2_pre0</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="">a</span><span class="delimiter">:</span><span class="string">&quot;list_all2 op &#8776; x x&#39;&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;list_all2 op &#8776; (x @ z) (x&#39; @ z)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">using</span><span class=""> </span><span class="">a</span><span class=""> </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">induct</span><span class=""> </span><span class="">x</span><span class=""> </span><span class="">x&#39;</span><span class=""> </span><span class="">rule</span><span class="delimiter">:</span><span class=""> </span><span class="">list_induct2&#39;</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">simp_all</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">list_all2_refl&#39;</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">list_eq_equivp</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">append_rsp2_pre1</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="">a</span><span class="delimiter">:</span><span class="string">&quot;list_all2 op &#8776; x x&#39;&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;list_all2 op &#8776; (z @ x) (z @ x&#39;)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">using</span><span class=""> </span><span class="">a</span><span class=""> </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">induct</span><span class=""> </span><span class="">x</span><span class=""> </span><span class="">x&#39;</span><span class=""> </span><span class="">arbitrary</span><span class="delimiter">:</span><span class=""> </span><span class="">z</span><span class=""> </span><span class="">rule</span><span class="delimiter">:</span><span class=""> </span><span class="">list_induct2&#39;</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">list_all2_refl&#39;</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">list_eq_equivp</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">simp_all</span><span class=""> </span><span class="">del</span><span class="delimiter">:</span><span class=""> </span><span class="">list_eq_def</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">list_all2_app_l</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">simp_all</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">reflpI</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">done</span></span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">append_rsp2_pre</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="string">&quot;list_all2 op &#8776; x x&#39;&quot;</span><span class="">
</span><span class="">    </span><span class="keyword2">and</span><span class=""> </span><span class="string">&quot;list_all2 op &#8776; z z&#39;&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;list_all2 op &#8776; (x @ z) (x&#39; @ z&#39;)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">using</span><span class=""> </span><span class="">assms</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">list_all2_appendI</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">compositional_rsp3</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="string">&quot;(R1 ===&gt; R2 ===&gt; R3) C C&quot;</span><span class=""> </span><span class="keyword2">and</span><span class=""> </span><span class="string">&quot;(R4 ===&gt; R5 ===&gt; R6) C C&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;(R1 OOO R4 ===&gt; R2 OOO R5 ===&gt; R3 OOO R6) C C&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">intro</span><span class="delimiter">!</span><span class="delimiter">:</span><span class=""> </span><span class="">rel_funI</span><span class="delimiter">)</span><span class="">
</span><span class="">     </span><span class="delimiter">(</span><span class="">metis</span><span class=""> </span><span class="delimiter">(</span><span class="">full_types</span><span class="delimiter">)</span><span class=""> </span><span class="">assms</span><span class=""> </span><span class="">rel_funE</span><span class=""> </span><span class="">relcomppI</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">append_rsp2</span><span class=""> </span><span class="delimiter">[</span><span class="">quot_respect</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="string">&quot;(list_all2 op &#8776; OOO op &#8776; ===&gt; list_all2 op &#8776; OOO op &#8776; ===&gt; list_all2 op &#8776; OOO op &#8776;) append append&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">intro</span><span class=""> </span><span class="">compositional_rsp3</span><span class="delimiter">)</span><span class="">
</span><span class="">     </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">intro</span><span class="delimiter">!</span><span class="delimiter">:</span><span class=""> </span><span class="">rel_funI</span><span class=""> </span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">append_rsp2_pre</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">map_rsp2</span><span class=""> </span><span class="delimiter">[</span><span class="">quot_respect</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="string">&quot;((op &#8776; ===&gt; op &#8776;) ===&gt; list_all2 op &#8776; OOO op &#8776; ===&gt; list_all2 op &#8776; OOO op &#8776;) map map&quot;</span><span class="">
</span><span class="keyword1">proof</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">intro</span><span class="delimiter">!</span><span class="delimiter">:</span><span class=""> </span><span class="">rel_funI</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword3">fix</span><span class=""> </span><span class="">f</span><span class=""> </span><span class="">f&#39;</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;&#39;a list &#8658; &#39;b list&quot;</span><span class="">
</span><span class="">  </span><span class="keyword3">fix</span><span class=""> </span><span class="">xa</span><span class=""> </span><span class="">ya</span><span class=""> </span><span class="">x</span><span class=""> </span><span class="">y</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;&#39;a list list&quot;</span><span class="">
</span><span class="">  </span><span class="keyword3">assume</span><span class=""> </span><span class="">fs</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;(op &#8776; ===&gt; op &#8776;) f f&#39;&quot;</span><span class=""> </span><span class="keyword2">and</span><span class=""> </span><span class="">x</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;list_all2 op &#8776; xa x&quot;</span><span class=""> </span><span class="keyword2">and</span><span class=""> </span><span class="">xy</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;set x = set y&quot;</span><span class=""> </span><span class="keyword2">and</span><span class=""> </span><span class="">y</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;list_all2 op &#8776; y ya&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">have</span><span class=""> </span><span class="">a</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;(list_all2 op &#8776;) (map f xa) (map f x)&quot;</span><span class="">
</span><span class="">    </span><span class="keyword1">using</span><span class=""> </span><span class="">x</span><span class="">
</span><span class="">    </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">induct</span><span class=""> </span><span class="">xa</span><span class=""> </span><span class="">x</span><span class=""> </span><span class="">rule</span><span class="delimiter">:</span><span class=""> </span><span class="">list_induct2&#39;</span><span class="delimiter">)</span><span class="">
</span><span class="">       </span><span class="delimiter">(</span><span class="">simp_all</span><span class="delimiter">,</span><span class=""> </span><span class="">metis</span><span class=""> </span><span class="">fs</span><span class=""> </span><span class="">rel_funE</span><span class=""> </span><span class="">list_eq_def</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">have</span><span class=""> </span><span class="">b</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;set (map f x) = set (map f y)&quot;</span><span class="">
</span><span class="">    </span><span class="keyword1">using</span><span class=""> </span><span class="">xy</span><span class=""> </span><span class="">fs</span><span class="">
</span><span class="">    </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">induct</span><span class=""> </span><span class="">x</span><span class=""> </span><span class="">y</span><span class=""> </span><span class="">rule</span><span class="delimiter">:</span><span class=""> </span><span class="">list_induct2&#39;</span><span class="delimiter">)</span><span class="">
</span><span class="">       </span><span class="delimiter">(</span><span class="">simp_all</span><span class="delimiter">,</span><span class=""> </span><span class="">metis</span><span class=""> </span><span class="">image_insert</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">have</span><span class=""> </span><span class="">c</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;(list_all2 op &#8776;) (map f y) (map f&#39; ya)&quot;</span><span class="">
</span><span class="">    </span><span class="keyword1">using</span><span class=""> </span><span class="">y</span><span class=""> </span><span class="">fs</span><span class="">
</span><span class="">    </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">induct</span><span class=""> </span><span class="">y</span><span class=""> </span><span class="">ya</span><span class=""> </span><span class="">rule</span><span class="delimiter">:</span><span class=""> </span><span class="">list_induct2&#39;</span><span class="delimiter">)</span><span class="">
</span><span class="">       </span><span class="delimiter">(</span><span class="">simp_all</span><span class="delimiter">,</span><span class=""> </span><span class="">metis</span><span class=""> </span><span class="">apply_rsp&#39;</span><span class=""> </span><span class="">list_eq_def</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;(list_all2 op &#8776; OOO op &#8776;) (map f xa) (map f&#39; ya)&quot;</span><span class="">
</span><span class="">    </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">metis</span><span class=""> </span><span class="">a</span><span class=""> </span><span class="">b</span><span class=""> </span><span class="">c</span><span class=""> </span><span class="">list_eq_def</span><span class=""> </span><span class="">relcomppI</span><span class="delimiter">)</span><span class="">
</span><span class="keyword1">qed</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">map_prs2</span><span class=""> </span><span class="delimiter">[</span><span class="">quot_preserve</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;((abs_fset ---&gt; rep_fset) ---&gt; (map rep_fset &#8728; rep_fset) ---&gt; abs_fset &#8728; map abs_fset) map = (id ---&gt; rep_fset ---&gt; abs_fset) map&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">fun_eq_iff</span><span class="delimiter">)</span><span class="">
</span><span class="">     </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">only</span><span class="delimiter">:</span><span class=""> </span><span class="">map_map</span><span class="delimiter">[</span><span class="">symmetric</span><span class="delimiter">]</span><span class=""> </span><span class="">map_prs_aux</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">Quotient3_fset</span><span class=""> </span><span class="">Quotient3_fset</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">section</span><span class=""> </span><span class="verbatim">{* Lifted theorems *}</span><span class="">
</span><span class="">
</span><span class="keyword1">subsection</span><span class=""> </span><span class="verbatim">{* fset *}</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">fset_simps</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;fset {||} = {}&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class="">   </span><span class="string">&quot;fset (insert_fset x S) = insert x (fset S)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">,</span><span class=""> </span><span class="">simp</span><span class="delimiter">)</span><span class="delimiter">+</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">finite_fset</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;finite (fset S)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">fset_cong</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;fset S = fset T &#10231; S = T&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">filter_fset</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;fset (filter_fset P xs) = Collect P &#8745; fset xs&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">remove_fset</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;fset (remove_fset x xs) = fset xs - {x}&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">inter_fset</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;fset (xs |&#8745;| ys) = fset xs &#8745; fset ys&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">union_fset</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;fset (xs |&#8746;| ys) = fset xs &#8746; fset ys&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">lifting</span><span class=""> </span><span class="">set_append</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">minus_fset</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;fset (xs - ys) = fset xs - fset ys&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">subsection</span><span class=""> </span><span class="verbatim">{* in_fset *}</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">in_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;x |&#8712;| S &#10231; x &#8712; fset S&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">descending</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">notin_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;x |&#8713;| S &#10231; x &#8713; fset S&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">in_fset</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">notin_empty_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;x |&#8713;| {||}&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">in_fset</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">fset_eq_iff</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;S = T &#10231; (&#8704;x. (x |&#8712;| S) = (x |&#8712;| T))&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">descending</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">none_in_empty_fset</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;(&#8704;x. x |&#8713;| S) &#10231; S = {||}&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">descending</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">subsection</span><span class=""> </span><span class="verbatim">{* insert_fset *}</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">in_insert_fset_iff</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;x |&#8712;| insert_fset y S &#10231; x = y &#8744; x |&#8712;| S&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">descending</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="">insert_fsetI1</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;x |&#8712;| insert_fset x S&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class="">   </span><span class="">insert_fsetI2</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;x |&#8712;| S &#10233; x |&#8712;| insert_fset y S&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">simp_all</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">insert_absorb_fset</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;x |&#8712;| S &#10233; insert_fset x S = S&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">empty_not_insert_fset</span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;{||} &#8800; insert_fset x S&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class="">   </span><span class="string">&quot;insert_fset x S &#8800; {||}&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">,</span><span class=""> </span><span class="">simp</span><span class="delimiter">)</span><span class="delimiter">+</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">insert_fset_left_comm</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;insert_fset x (insert_fset y S) = insert_fset y (insert_fset x S)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">insert_fset_left_idem</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;insert_fset x (insert_fset x S) = insert_fset x S&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">singleton_fset_eq</span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;{|x|} = {|y|} &#10231; x = y&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">in_fset_mdef</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;x |&#8712;| F &#10231; x |&#8713;| (F - {|x|}) &#8743; F = insert_fset x (F - {|x|})&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">subsection</span><span class=""> </span><span class="verbatim">{* union_fset *}</span><span class="">
</span><span class="">
</span><span class="keyword1">lemmas</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class=""> </span><span class="delimiter">=</span><span class="">
</span><span class="">  </span><span class="">sup_bot_left</span><span class="delimiter">[</span><span class="keyword2">where</span><span class=""> </span><span class="tfree">&#39;a</span><span class="delimiter">=</span><span class="string">&quot;&#39;a fset&quot;</span><span class="delimiter">]</span><span class="">
</span><span class="">  </span><span class="">sup_bot_right</span><span class="delimiter">[</span><span class="keyword2">where</span><span class=""> </span><span class="tfree">&#39;a</span><span class="delimiter">=</span><span class="string">&quot;&#39;a fset&quot;</span><span class="delimiter">]</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">union_insert_fset</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;insert_fset x S |&#8746;| T = insert_fset x (S |&#8746;| T)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">lifting</span><span class=""> </span><span class="">append.simps</span><span class="delimiter">(</span><span class="">2</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">singleton_union_fset_left</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;{|a|} |&#8746;| S = insert_fset a S&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">singleton_union_fset_right</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;S |&#8746;| {|a|} = insert_fset a S&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">subst</span><span class=""> </span><span class="">sup.commute</span><span class="delimiter">)</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">in_union_fset</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;x |&#8712;| S |&#8746;| T &#10231; x |&#8712;| S &#8744; x |&#8712;| T&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">subsection</span><span class=""> </span><span class="verbatim">{* minus_fset *}</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">minus_in_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;x |&#8712;| (xs - ys) &#10231; x |&#8712;| xs &#8743; x |&#8713;| ys&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">minus_insert_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;insert_fset x xs - ys = (if x |&#8712;| ys then xs - ys else insert_fset x (xs - ys))&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">minus_insert_in_fset</span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;x |&#8712;| ys &#10233; insert_fset x xs - ys = xs - ys&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">minus_insert_fset</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">minus_insert_notin_fset</span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;x |&#8713;| ys &#10233; insert_fset x xs - ys = insert_fset x (xs - ys)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">minus_insert_fset</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">in_minus_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;x |&#8712;| F - S &#10233; x |&#8713;| S&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">unfolding</span><span class=""> </span><span class="">in_fset</span><span class=""> </span><span class="">minus_fset</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">blast</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">notin_minus_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;x |&#8712;| S &#10233; x |&#8713;| F - S&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">unfolding</span><span class=""> </span><span class="">in_fset</span><span class=""> </span><span class="">minus_fset</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">blast</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">subsection</span><span class=""> </span><span class="verbatim">{* remove_fset *}</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">in_remove_fset</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;x |&#8712;| remove_fset y S &#10231; x |&#8712;| S &#8743; x &#8800; y&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">notin_remove_fset</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;x |&#8713;| remove_fset x S&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">notin_remove_ident_fset</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;x |&#8713;| S &#10233; remove_fset x S = S&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">remove_fset_cases</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;S = {||} &#8744; (&#8707;x. x |&#8712;| S &#8743; S = insert_fset x (remove_fset x S))&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">insert_absorb</span><span class="delimiter">)</span><span class="">
</span><span class="">  
</span><span class="">
</span><span class="keyword1">subsection</span><span class=""> </span><span class="verbatim">{* inter_fset *}</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">inter_empty_fset_l</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;{||} |&#8745;| S = {||}&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">inter_empty_fset_r</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;S |&#8745;| {||} = {||}&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">inter_insert_fset</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;insert_fset x S |&#8745;| T = (if x |&#8712;| T then insert_fset x (S |&#8745;| T) else S |&#8745;| T)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">in_inter_fset</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;x |&#8712;| (S |&#8745;| T) &#10231; x |&#8712;| S &#8743; x |&#8712;| T&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">subsection</span><span class=""> </span><span class="verbatim">{* subset_fset and psubset_fset *}</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">subset_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;xs |&#8838;| ys &#10231; fset xs &#8838; fset ys&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">psubset_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;xs |&#8834;| ys &#10231; fset xs &#8834; fset ys&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">unfolding</span><span class=""> </span><span class="">less_fset_def</span><span class=""> 
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">subset_insert_fset</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;(insert_fset x xs) |&#8838;| ys &#10231; x |&#8712;| ys &#8743; xs |&#8838;| ys&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">subset_in_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;xs |&#8838;| ys = (&#8704;x. x |&#8712;| xs &#10230; x |&#8712;| ys)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">subset_empty_fset</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;xs |&#8838;| {||} &#10231; xs = {||}&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">not_psubset_empty_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;&#172; xs |&#8834;| {||}&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">metis</span><span class=""> </span><span class="">fset_simps</span><span class="delimiter">(</span><span class="">1</span><span class="delimiter">)</span><span class=""> </span><span class="">psubset_fset</span><span class=""> </span><span class="">not_psubset_empty</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">subsection</span><span class=""> </span><span class="verbatim">{* map_fset *}</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">map_fset_simps</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">   </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;map_fset f {||} = {||}&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class="">   </span><span class="string">&quot;map_fset f (insert_fset x S) = insert_fset (f x) (map_fset f S)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">,</span><span class=""> </span><span class="">simp</span><span class="delimiter">)</span><span class="delimiter">+</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">map_fset_image</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;fset (map_fset f S) = f ` (fset S)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">inj_map_fset_cong</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;inj f &#10233; map_fset f S = map_fset f T &#10231; S = T&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">metis</span><span class=""> </span><span class="">inj_vimage_image_eq</span><span class=""> </span><span class="">list_eq_def</span><span class=""> </span><span class="">set_map</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">map_union_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;map_fset f (S |&#8746;| T) = map_fset f S |&#8746;| map_fset f T&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">in_fset_map_fset</span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;a |&#8712;| map_fset f X = (&#8707;b. b |&#8712;| X &#8743; a = f b)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">descending</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">subsection</span><span class=""> </span><span class="verbatim">{* card_fset *}</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;card_fset xs = card (fset xs)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_insert_fset_iff</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;card_fset (insert_fset x S) = (if x |&#8712;| S then card_fset S else Suc (card_fset S))&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">insert_absorb</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_fset_0</span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;card_fset S = 0 &#10231; S = {||}&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_empty_fset</span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;card_fset {||} = 0&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">card_fset</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_fset_1</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;card_fset S = 1 &#10231; (&#8707;x. S = {|x|})&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">card_Suc_eq</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_fset_gt_0</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;x &#8712; fset S &#10233; 0 &lt; card_fset S&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">card_gt_0_iff</span><span class="delimiter">)</span><span class="">
</span><span class="">  
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_notin_fset</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;(x |&#8713;| S) = (card_fset (insert_fset x S) = Suc (card_fset S))&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_fset_Suc</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;card_fset S = Suc n &#10233; &#8707;x T. x |&#8713;| T &#8743; S = insert_fset x T &#8743; card_fset T = n&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">dest</span><span class="delimiter">!</span><span class="delimiter">:</span><span class=""> </span><span class="">card_eq_SucD</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">metis</span><span class=""> </span><span class="">Diff_insert_absorb</span><span class=""> </span><span class="">set_removeAll</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_remove_fset_iff</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;card_fset (remove_fset y S) = (if y |&#8712;| S then card_fset S - 1 else card_fset S)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_Suc_exists_in_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;card_fset S = Suc n &#10233; &#8707;a. a |&#8712;| S&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">drule</span><span class=""> </span><span class="">card_fset_Suc</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">in_card_fset_not_0</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;a |&#8712;| A &#10233; card_fset A &#8800; 0&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_fset_mono</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;xs |&#8838;| ys &#10233; card_fset xs &#8804; card_fset ys&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">unfolding</span><span class=""> </span><span class="">card_fset</span><span class=""> </span><span class="">psubset_fset</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">card_mono</span><span class=""> </span><span class="">subset_fset</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_subset_fset_eq</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;xs |&#8838;| ys &#10233; card_fset ys &#8804; card_fset xs &#10233; xs = ys&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">unfolding</span><span class=""> </span><span class="">card_fset</span><span class=""> </span><span class="">subset_fset</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">dest</span><span class="delimiter">:</span><span class=""> </span><span class="">card_seteq</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">finite_fset</span><span class="delimiter">]</span><span class=""> </span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">fset_cong</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">psubset_card_fset_mono</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;xs |&#8834;| ys &#10233; card_fset xs &lt; card_fset ys&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">unfolding</span><span class=""> </span><span class="">card_fset</span><span class=""> </span><span class="">subset_fset</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">metis</span><span class=""> </span><span class="">finite_fset</span><span class=""> </span><span class="">psubset_fset</span><span class=""> </span><span class="">psubset_card_mono</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_union_inter_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;card_fset xs + card_fset ys = card_fset (xs |&#8746;| ys) + card_fset (xs |&#8745;| ys)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">unfolding</span><span class=""> </span><span class="">card_fset</span><span class=""> </span><span class="">union_fset</span><span class=""> </span><span class="">inter_fset</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">card_Un_Int</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">finite_fset</span><span class=""> </span><span class="">finite_fset</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_union_disjoint_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;xs |&#8745;| ys = {||} &#10233; card_fset (xs |&#8746;| ys) = card_fset xs + card_fset ys&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">unfolding</span><span class=""> </span><span class="">card_fset</span><span class=""> </span><span class="">union_fset</span><span class=""> 
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">card_Un_disjoint</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">finite_fset</span><span class=""> </span><span class="">finite_fset</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">metis</span><span class=""> </span><span class="">inter_fset</span><span class=""> </span><span class="">fset_simps</span><span class="delimiter">(</span><span class="">1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_remove_fset_less1</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;x |&#8712;| xs &#10233; card_fset (remove_fset x xs) &lt; card_fset xs&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">unfolding</span><span class=""> </span><span class="">card_fset</span><span class=""> </span><span class="">in_fset</span><span class=""> </span><span class="">remove_fset</span><span class=""> 
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">card_Diff1_less</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">finite_fset</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_remove_fset_less2</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;x |&#8712;| xs &#10233; y |&#8712;| xs &#10233; card_fset (remove_fset y (remove_fset x xs)) &lt; card_fset xs&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">unfolding</span><span class=""> </span><span class="">card_fset</span><span class=""> </span><span class="">remove_fset</span><span class=""> </span><span class="">in_fset</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">card_Diff2_less</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">finite_fset</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_remove_fset_le1</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;card_fset (remove_fset x xs) &#8804; card_fset xs&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">unfolding</span><span class=""> </span><span class="">remove_fset</span><span class=""> </span><span class="">card_fset</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">card_Diff1_le</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">finite_fset</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_psubset_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;ys |&#8838;| xs &#10233; card_fset ys &lt; card_fset xs &#10233; ys |&#8834;| xs&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">unfolding</span><span class=""> </span><span class="">card_fset</span><span class=""> </span><span class="">psubset_fset</span><span class=""> </span><span class="">subset_fset</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">card_psubset</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">finite_fset</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_map_fset_le</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;card_fset (map_fset f xs) &#8804; card_fset xs&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">unfolding</span><span class=""> </span><span class="">card_fset</span><span class=""> </span><span class="">map_fset_image</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">card_image_le</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">finite_fset</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_minus_insert_fset</span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="string">&quot;a |&#8712;| A&quot;</span><span class=""> </span><span class="keyword2">and</span><span class=""> </span><span class="string">&quot;a |&#8713;| B&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;card_fset (A - insert_fset a B) = card_fset (A - B) - 1&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">using</span><span class=""> </span><span class="">assms</span><span class=""> 
</span><span class="">  </span><span class="keyword1">unfolding</span><span class=""> </span><span class="">in_fset</span><span class=""> </span><span class="">card_fset</span><span class=""> </span><span class="">minus_fset</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">card_Diff_insert</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">finite_fset</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_minus_subset_fset</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="string">&quot;B |&#8838;| A&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;card_fset (A - B) = card_fset A - card_fset B&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">using</span><span class=""> </span><span class="">assms</span><span class=""> 
</span><span class="">  </span><span class="keyword1">unfolding</span><span class=""> </span><span class="">subset_fset</span><span class=""> </span><span class="">card_fset</span><span class=""> </span><span class="">minus_fset</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">card_Diff_subset</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">finite_fset</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">card_minus_fset</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;card_fset (A - B) = card_fset A - card_fset (A |&#8745;| B)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">unfolding</span><span class=""> </span><span class="">inter_fset</span><span class=""> </span><span class="">card_fset</span><span class=""> </span><span class="">minus_fset</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">card_Diff_subset_Int</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">subsection</span><span class=""> </span><span class="verbatim">{* concat_fset *}</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">concat_empty_fset</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;concat_fset {||} = {||}&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">descending</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">concat_insert_fset</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;concat_fset (insert_fset x S) = x |&#8746;| concat_fset S&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">descending</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">concat_union_fset</span><span class=""> </span><span class="delimiter">[</span><span class="">simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;concat_fset (xs |&#8746;| ys) = concat_fset xs |&#8746;| concat_fset ys&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">descending</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">map_concat_fset</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;map_fset f (concat_fset xs) = concat_fset (map_fset (map_fset f) xs)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">lifting</span><span class=""> </span><span class="">map_concat</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">subsection</span><span class=""> </span><span class="verbatim">{* filter_fset *}</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">subset_filter_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="string">&quot;filter_fset P xs |&#8838;| filter_fset Q xs = (&#8704; x. x |&#8712;| xs &#10230; P x &#10230; Q x)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">descending</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">eq_filter_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="string">&quot;(filter_fset P xs = filter_fset Q xs) = (&#8704;x. x |&#8712;| xs &#10230; P x = Q x)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">descending</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">psubset_filter_fset</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="string">&quot;(&#8896;x. x |&#8712;| xs &#10233; P x &#10233; Q x) &#10233; (x |&#8712;| xs &amp; &#172; P x &amp; Q x) &#10233; 
    filter_fset P xs |&#8834;| filter_fset Q xs&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">unfolding</span><span class=""> </span><span class="">less_fset_def</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">subset_filter_fset</span><span class=""> </span><span class="">eq_filter_fset</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">subsection</span><span class=""> </span><span class="verbatim">{* fold_fset *}</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">fold_empty_fset</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="string">&quot;fold_fset f {||} = id&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">descending</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">fold_once_def</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">fold_insert_fset</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;fold_fset f (insert_fset a A) =
  (if rsp_fold f then if a |&#8712;| A then fold_fset f A else fold_fset f A &#8728; f a else id)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">descending</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">fold_once_fold_remdups</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">remdups_removeAll</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="string">&quot;remdups (removeAll x xs) = remove1 x (remdups xs)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">induct</span><span class=""> </span><span class="">xs</span><span class="delimiter">)</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">member_commute_fold_once</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="string">&quot;rsp_fold f&quot;</span><span class="">
</span><span class="">    </span><span class="keyword2">and</span><span class=""> </span><span class="string">&quot;x &#8712; set xs&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;fold_once f xs = fold_once f (removeAll x xs) &#8728; f x&quot;</span><span class="">
</span><span class="keyword1">proof</span><span class=""> </span><span class="">-</span><span class="">
</span><span class="">  </span><span class="keyword1">from</span><span class=""> </span><span class="">assms</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;fold f (remdups xs) = fold f (remove1 x (remdups xs)) &#8728; f x&quot;</span><span class="">
</span><span class="">    </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">intro</span><span class="delimiter">!</span><span class="delimiter">:</span><span class=""> </span><span class="">fold_remove1_split</span><span class=""> </span><span class="">elim</span><span class="delimiter">:</span><span class=""> </span><span class="">rsp_foldE</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">then</span><span class=""> </span><span class="keyword3">show</span><span class=""> </span><span class="var">?thesis</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="alt_string">`rsp_fold f`</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">fold_once_fold_remdups</span><span class=""> </span><span class="">remdups_removeAll</span><span class="delimiter">)</span><span class="">
</span><span class="keyword1">qed</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">in_commute_fold_fset</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="string">&quot;rsp_fold f &#10233; h |&#8712;| b &#10233; fold_fset f b = fold_fset f (remove_fset h b) &#8728; f h&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">descending</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">member_commute_fold_once</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">subsection</span><span class=""> </span><span class="verbatim">{* Choice in fsets *}</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">fset_choice</span><span class="delimiter">:</span><span class=""> 
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="">a</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;&#8704;x. x |&#8712;| A &#10230; (&#8707;y. P x y)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;&#8707;f. &#8704;x. x |&#8712;| A &#10230; P x (f x)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">using</span><span class=""> </span><span class="">a</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">using</span><span class=""> </span><span class="">finite_set_choice</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">Ball_def</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">section</span><span class=""> </span><span class="verbatim">{* Induction and Cases rules for fsets *}</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">fset_exhaust</span><span class=""> </span><span class="delimiter">[</span><span class="">case_names</span><span class=""> </span><span class="">empty</span><span class=""> </span><span class="">insert</span><span class="delimiter">,</span><span class=""> </span><span class="">cases</span><span class=""> </span><span class="">type</span><span class="delimiter">:</span><span class=""> </span><span class="">fset</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="">empty_fset_case</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;S = {||} &#10233; P&quot;</span><span class=""> 
</span><span class="">  </span><span class="keyword2">and</span><span class="">     </span><span class="">insert_fset_case</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;&#8896;x S&#39;. S = insert_fset x S&#39; &#10233; P&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;P&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">using</span><span class=""> </span><span class="">assms</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">lifting</span><span class=""> </span><span class="">list.exhaust</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">fset_induct</span><span class=""> </span><span class="delimiter">[</span><span class="">case_names</span><span class=""> </span><span class="">empty</span><span class=""> </span><span class="">insert</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="">empty_fset_case</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;P {||}&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class="">     </span><span class="">insert_fset_case</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;&#8896;x S. P S &#10233; P (insert_fset x S)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;P S&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">using</span><span class=""> </span><span class="">assms</span><span class=""> 
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">descending</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">blast</span><span class=""> </span><span class="">intro</span><span class="delimiter">:</span><span class=""> </span><span class="">list.induct</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">fset_induct_stronger</span><span class=""> </span><span class="delimiter">[</span><span class="">case_names</span><span class=""> </span><span class="">empty</span><span class=""> </span><span class="">insert</span><span class="delimiter">,</span><span class=""> </span><span class="">induct</span><span class=""> </span><span class="">type</span><span class="delimiter">:</span><span class=""> </span><span class="">fset</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="">empty_fset_case</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;P {||}&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class="">     </span><span class="">insert_fset_case</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;&#8896;x S. &#10214;x |&#8713;| S; P S&#10215; &#10233; P (insert_fset x S)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;P S&quot;</span><span class="">
</span><span class="keyword1">proof</span><span class="delimiter">(</span><span class="">induct</span><span class=""> </span><span class="">S</span><span class=""> </span><span class="">rule</span><span class="delimiter">:</span><span class=""> </span><span class="">fset_induct</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword3">case</span><span class=""> </span><span class="">empty</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;P {||}&quot;</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">empty_fset_case</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="keyword1">next</span><span class="">
</span><span class="">  </span><span class="keyword3">case</span><span class=""> </span><span class="delimiter">(</span><span class="">insert</span><span class=""> </span><span class="">x</span><span class=""> </span><span class="">S</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;P S&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">fact</span><span class="">
</span><span class="">  </span><span class="keyword1">then</span><span class=""> </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;P (insert_fset x S)&quot;</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">insert_fset_case</span><span class=""> 
</span><span class="">    </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">cases</span><span class=""> </span><span class="string">&quot;x |&#8712;| S&quot;</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">simp_all</span><span class="delimiter">)</span><span class="">
</span><span class="keyword1">qed</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">fset_card_induct</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="">empty_fset_case</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;P {||}&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class="">     </span><span class="">card_fset_Suc_case</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;&#8896;S T. Suc (card_fset S) = (card_fset T) &#10233; P S &#10233; P T&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;P S&quot;</span><span class="">
</span><span class="keyword1">proof</span><span class=""> </span><span class="delimiter">(</span><span class="">induct</span><span class=""> </span><span class="">S</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword3">case</span><span class=""> </span><span class="">empty</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;P {||}&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">empty_fset_case</span><span class="delimiter">)</span><span class="">
</span><span class="keyword1">next</span><span class="">
</span><span class="">  </span><span class="keyword3">case</span><span class=""> </span><span class="delimiter">(</span><span class="">insert</span><span class=""> </span><span class="">x</span><span class=""> </span><span class="">S</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">have</span><span class=""> </span><span class="">h</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;P S&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">fact</span><span class="">
</span><span class="">  </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;x |&#8713;| S&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">fact</span><span class="">
</span><span class="">  </span><span class="keyword1">then</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;Suc (card_fset S) = card_fset (insert_fset x S)&quot;</span><span class=""> 
</span><span class="">    </span><span class="keyword1">using</span><span class=""> </span><span class="">card_fset_Suc</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="">  </span><span class="keyword1">then</span><span class=""> </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;P (insert_fset x S)&quot;</span><span class=""> 
</span><span class="">    </span><span class="keyword1">using</span><span class=""> </span><span class="">h</span><span class=""> </span><span class="">card_fset_Suc_case</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="keyword1">qed</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">fset_raw_strong_cases</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">obtains</span><span class=""> </span><span class="string">&quot;xs = []&quot;</span><span class="">
</span><span class="">    </span><span class="delimiter">|</span><span class=""> </span><span class="">ys</span><span class=""> </span><span class="">x</span><span class=""> </span><span class="keyword2">where</span><span class=""> </span><span class="string">&quot;&#172; List.member ys x&quot;</span><span class=""> </span><span class="keyword2">and</span><span class=""> </span><span class="string">&quot;xs &#8776; x # ys&quot;</span><span class="">
</span><span class="keyword1">proof</span><span class=""> </span><span class="delimiter">(</span><span class="">induct</span><span class=""> </span><span class="">xs</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword3">case</span><span class=""> </span><span class="">Nil</span><span class="">
</span><span class="">  </span><span class="keyword1">then</span><span class=""> </span><span class="keyword3">show</span><span class=""> </span><span class="">thesis</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="keyword1">next</span><span class="">
</span><span class="">  </span><span class="keyword3">case</span><span class=""> </span><span class="delimiter">(</span><span class="">Cons</span><span class=""> </span><span class="">a</span><span class=""> </span><span class="">xs</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">have</span><span class=""> </span><span class="">a</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;&#10214;xs = [] &#10233; thesis; &#8896;x ys. &#10214;&#172; List.member ys x; xs &#8776; x # ys&#10215; &#10233; thesis&#10215; &#10233; thesis&quot;</span><span class="">
</span><span class="">    </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">Cons</span><span class="delimiter">(</span><span class="">1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">have</span><span class=""> </span><span class="">b</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;&#8896;x&#39; ys&#39;. &#10214;&#172; List.member ys&#39; x&#39;; a # xs &#8776; x&#39; # ys&#39;&#10215; &#10233; thesis&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">fact</span><span class="">
</span><span class="">  </span><span class="keyword1">have</span><span class=""> </span><span class="">c</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;xs = [] &#10233; thesis&quot;</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">b</span><span class=""> 
</span><span class="">    </span><span class="keyword1"><span class="improper">apply</span></span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">    </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">metis</span><span class=""> </span><span class="">list.set</span><span class="delimiter">(</span><span class="">1</span><span class="delimiter">)</span><span class=""> </span><span class="">emptyE</span><span class=""> </span><span class="">empty_subsetI</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;&#8896;x ys. &#10214;&#172; List.member ys x; xs &#8776; x # ys&#10215; &#10233; thesis&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">proof</span><span class=""> </span><span class="">-</span><span class="">
</span><span class="">    </span><span class="keyword3">fix</span><span class=""> </span><span class="">x</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="tfree">&#39;a</span><span class="">
</span><span class="">    </span><span class="keyword3">fix</span><span class=""> </span><span class="">ys</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;&#39;a list&quot;</span><span class="">
</span><span class="">    </span><span class="keyword3">assume</span><span class=""> </span><span class="">d</span><span class="delimiter">:</span><span class="string">&quot;&#172; List.member ys x&quot;</span><span class="">
</span><span class="">    </span><span class="keyword3">assume</span><span class=""> </span><span class="">e</span><span class="delimiter">:</span><span class="string">&quot;xs &#8776; x # ys&quot;</span><span class="">
</span><span class="">    </span><span class="keyword3">show</span><span class=""> </span><span class="">thesis</span><span class="">
</span><span class="">    </span><span class="keyword1">proof</span><span class=""> </span><span class="delimiter">(</span><span class="">cases</span><span class=""> </span><span class="string">&quot;x = a&quot;</span><span class="delimiter">)</span><span class="">
</span><span class="">      </span><span class="keyword3">assume</span><span class=""> </span><span class="">h</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;x = a&quot;</span><span class="">
</span><span class="">      </span><span class="keyword1">then</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="">f</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;&#172; List.member ys a&quot;</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">d</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">      </span><span class="keyword1">have</span><span class=""> </span><span class="">g</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;a # xs &#8776; a # ys&quot;</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">e</span><span class=""> </span><span class="">h</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="">      </span><span class="keyword3">show</span><span class=""> </span><span class="">thesis</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">b</span><span class=""> </span><span class="">f</span><span class=""> </span><span class="">g</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">    </span><span class="keyword1">next</span><span class="">
</span><span class="">      </span><span class="keyword3">assume</span><span class=""> </span><span class="">h</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;x &#8800; a&quot;</span><span class="">
</span><span class="">      </span><span class="keyword1">then</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="">f</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;&#172; List.member (a # ys) x&quot;</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">d</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="">      </span><span class="keyword1">have</span><span class=""> </span><span class="">g</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;a # xs &#8776; x # (a # ys)&quot;</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">e</span><span class=""> </span><span class="">h</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="">      </span><span class="keyword3">show</span><span class=""> </span><span class="">thesis</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">b</span><span class=""> </span><span class="">f</span><span class=""> </span><span class="">g</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">del</span><span class="delimiter">:</span><span class=""> </span><span class="">List.member_def</span><span class="delimiter">)</span><span class=""> 
</span><span class="">    </span><span class="keyword1">qed</span><span class="">
</span><span class="">  </span><span class="keyword1">qed</span><span class="">
</span><span class="">  </span><span class="keyword1">then</span><span class=""> </span><span class="keyword3">show</span><span class=""> </span><span class="">thesis</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">a</span><span class=""> </span><span class="">c</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">blast</span><span class="">
</span><span class="keyword1">qed</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">fset_strong_cases</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">obtains</span><span class=""> </span><span class="string">&quot;xs = {||}&quot;</span><span class="">
</span><span class="">    </span><span class="delimiter">|</span><span class=""> </span><span class="">ys</span><span class=""> </span><span class="">x</span><span class=""> </span><span class="keyword2">where</span><span class=""> </span><span class="string">&quot;x |&#8713;| ys&quot;</span><span class=""> </span><span class="keyword2">and</span><span class=""> </span><span class="string">&quot;xs = insert_fset x ys&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">lifting</span><span class=""> </span><span class="">fset_raw_strong_cases</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">fset_induct2</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="string">&quot;P {||} {||} &#10233;
  (&#8896;x xs. x |&#8713;| xs &#10233; P (insert_fset x xs) {||}) &#10233;
  (&#8896;y ys. y |&#8713;| ys &#10233; P {||} (insert_fset y ys)) &#10233;
  (&#8896;x xs y ys. &#10214;P xs ys; x |&#8713;| xs; y |&#8713;| ys&#10215; &#10233; P (insert_fset x xs) (insert_fset y ys)) &#10233;
  P xsa ysa&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">induct</span><span class=""> </span><span class="">xsa</span><span class=""> </span><span class="">arbitrary</span><span class="delimiter">:</span><span class=""> </span><span class="">ysa</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">induct_tac</span><span class=""> </span><span class="">x</span><span class=""> </span><span class="">rule</span><span class="delimiter">:</span><span class=""> </span><span class="">fset_induct_stronger</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="">simp_all</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">induct_tac</span><span class=""> </span><span class="">xa</span><span class=""> </span><span class="">rule</span><span class="delimiter">:</span><span class=""> </span><span class="">fset_induct_stronger</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="">simp_all</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">done</span></span><span class="">
</span><span class="">
</span><span class="keyword1">text</span><span class=""> </span><span class="verbatim">{* Extensionality *}</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">fset_eqI</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="string">&quot;&#8896;x. x &#8712; fset A &#10231; x &#8712; fset B&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;A = B&quot;</span><span class="">
</span><span class="keyword1">using</span><span class=""> </span><span class="">assms</span><span class=""> </span><span class="keyword1">proof</span><span class=""> </span><span class="delimiter">(</span><span class="">induct</span><span class=""> </span><span class="">A</span><span class=""> </span><span class="">arbitrary</span><span class="delimiter">:</span><span class=""> </span><span class="">B</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword3">case</span><span class=""> </span><span class="">empty</span><span class=""> </span><span class="keyword1">then</span><span class=""> </span><span class="keyword3">show</span><span class=""> </span><span class="var">?case</span><span class="">
</span><span class="">    </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">in_fset</span><span class=""> </span><span class="">none_in_empty_fset</span><span class=""> </span><span class="delimiter">[</span><span class="">symmetric</span><span class="delimiter">]</span><span class=""> </span><span class="">sym</span><span class="delimiter">)</span><span class="">
</span><span class="keyword1">next</span><span class="">
</span><span class="">  </span><span class="keyword3">case</span><span class=""> </span><span class="delimiter">(</span><span class="">insert</span><span class=""> </span><span class="">x</span><span class=""> </span><span class="">A</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">from</span><span class=""> </span><span class="">insert.prems</span><span class=""> </span><span class="">insert.hyps</span><span class="delimiter">(</span><span class="">1</span><span class="delimiter">)</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;&#8896;z. z &#8712; fset A &#10231; z &#8712; fset (B - {|x|})&quot;</span><span class="">
</span><span class="">    </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">in_fset</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">then</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="">A</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;A = B - {|x|}&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">insert.hyps</span><span class="delimiter">(</span><span class="">2</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">with</span><span class=""> </span><span class="">insert.prems</span><span class=""> </span><span class="delimiter">[</span><span class="">symmetric</span><span class="delimiter">,</span><span class=""> </span><span class="">of</span><span class=""> </span><span class="">x</span><span class="delimiter">]</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;x |&#8712;| B&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">in_fset</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1">with</span><span class=""> </span><span class="">A</span><span class=""> </span><span class="keyword3">show</span><span class=""> </span><span class="var">?case</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">metis</span><span class=""> </span><span class="">in_fset_mdef</span><span class="delimiter">)</span><span class="">
</span><span class="keyword1">qed</span><span class="">
</span><span class="">
</span><span class="keyword1">subsection</span><span class=""> </span><span class="verbatim">{* alternate formulation with a different decomposition principle
  and a proof of equivalence *}</span><span class="">
</span><span class="">
</span><span class="keyword1">inductive</span><span class="">
</span><span class="">  </span><span class="">list_eq2</span><span class=""> </span><span class="delimiter">::</span><span class=""> </span><span class="string">&quot;&#39;a list &#8658; &#39;a list &#8658; bool&quot;</span><span class=""> </span><span class="delimiter">(</span><span class="string">&quot;_ &#8776;2 _&quot;</span><span class="delimiter">)</span><span class="">
</span><span class="keyword2">where</span><span class="">
</span><span class="">  </span><span class="string">&quot;(a # b # xs) &#8776;2 (b # a # xs)&quot;</span><span class="">
</span><span class="delimiter">|</span><span class=""> </span><span class="string">&quot;[] &#8776;2 []&quot;</span><span class="">
</span><span class="delimiter">|</span><span class=""> </span><span class="string">&quot;xs &#8776;2 ys &#10233; ys &#8776;2 xs&quot;</span><span class="">
</span><span class="delimiter">|</span><span class=""> </span><span class="string">&quot;(a # a # xs) &#8776;2 (a # xs)&quot;</span><span class="">
</span><span class="delimiter">|</span><span class=""> </span><span class="string">&quot;xs &#8776;2 ys &#10233; (a # xs) &#8776;2 (a # ys)&quot;</span><span class="">
</span><span class="delimiter">|</span><span class=""> </span><span class="string">&quot;xs1 &#8776;2 xs2 &#10233; xs2 &#8776;2 xs3 &#10233; xs1 &#8776;2 xs3&quot;</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">list_eq2_refl</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;xs &#8776;2 xs&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">induct</span><span class=""> </span><span class="">xs</span><span class="delimiter">)</span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">intro</span><span class="delimiter">:</span><span class=""> </span><span class="">list_eq2.intros</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">cons_delete_list_eq2</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;(a # (removeAll a A)) &#8776;2 (if List.member A a then A else a # A)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">induct</span><span class=""> </span><span class="">A</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">list_eq2_refl</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">case_tac</span><span class=""> </span><span class="string">&quot;List.member (aa # A) a&quot;</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">simp_all</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">case_tac</span><span class=""> </span><span class="delimiter">[</span><span class="delimiter">!</span><span class="delimiter">]</span><span class=""> </span><span class="string">&quot;a = aa&quot;</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">simp_all</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">case_tac</span><span class=""> </span><span class="string">&quot;List.member A a&quot;</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class="delimiter">)</span><span class="delimiter">[</span><span class="">2</span><span class="delimiter">]</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">metis</span><span class=""> </span><span class="">list_eq2.intros</span><span class="delimiter">(</span><span class="">3</span><span class="delimiter">)</span><span class=""> </span><span class="">list_eq2.intros</span><span class="delimiter">(</span><span class="">4</span><span class="delimiter">)</span><span class=""> </span><span class="">list_eq2.intros</span><span class="delimiter">(</span><span class="">5</span><span class="delimiter">)</span><span class=""> </span><span class="">list_eq2.intros</span><span class="delimiter">(</span><span class="">6</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">metis</span><span class=""> </span><span class="">list_eq2.intros</span><span class="delimiter">(</span><span class="">1</span><span class="delimiter">)</span><span class=""> </span><span class="">list_eq2.intros</span><span class="delimiter">(</span><span class="">5</span><span class="delimiter">)</span><span class=""> </span><span class="">list_eq2.intros</span><span class="delimiter">(</span><span class="">6</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">apply</span></span><span class=""> </span><span class="delimiter">(</span><span class="">auto</span><span class=""> </span><span class="">simp</span><span class=""> </span><span class="">add</span><span class="delimiter">:</span><span class=""> </span><span class="">list_eq2_refl</span><span class="delimiter">)</span><span class="">
</span><span class="">  </span><span class="keyword1"><span class="improper">done</span></span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">member_delete_list_eq2</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="">a</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;List.member r e&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;(e # removeAll e r) &#8776;2 r&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">using</span><span class=""> </span><span class="">a</span><span class=""> </span><span class="">cons_delete_list_eq2</span><span class="delimiter">[</span><span class="">of</span><span class=""> </span><span class="">e</span><span class=""> </span><span class="">r</span><span class="delimiter">]</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">list_eq2_equiv</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="string">&quot;(l &#8776; r) &#10231; (list_eq2 l r)&quot;</span><span class="">
</span><span class="keyword1">proof</span><span class="">
</span><span class="">  </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;list_eq2 l r &#10233; l &#8776; r&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">induct</span><span class=""> </span><span class="">rule</span><span class="delimiter">:</span><span class=""> </span><span class="">list_eq2.induct</span><span class="delimiter">)</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="keyword1">next</span><span class="">
</span><span class="">  </span><span class="keyword1">{</span><span class="">
</span><span class="">    </span><span class="keyword3">fix</span><span class=""> </span><span class="">n</span><span class="">
</span><span class="">    </span><span class="keyword3">assume</span><span class=""> </span><span class="">a</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;card_list l = n&quot;</span><span class=""> </span><span class="keyword2">and</span><span class=""> </span><span class="">b</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;l &#8776; r&quot;</span><span class="">
</span><span class="">    </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;l &#8776;2 r&quot;</span><span class="">
</span><span class="">      </span><span class="keyword1">using</span><span class=""> </span><span class="">a</span><span class=""> </span><span class="">b</span><span class="">
</span><span class="">    </span><span class="keyword1">proof</span><span class=""> </span><span class="delimiter">(</span><span class="">induct</span><span class=""> </span><span class="">n</span><span class=""> </span><span class="">arbitrary</span><span class="delimiter">:</span><span class=""> </span><span class="">l</span><span class=""> </span><span class="">r</span><span class="delimiter">)</span><span class="">
</span><span class="">      </span><span class="keyword3">case</span><span class=""> </span><span class="">0</span><span class="">
</span><span class="">      </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;card_list l = 0&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">fact</span><span class="">
</span><span class="">      </span><span class="keyword1">then</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;&#8704;x. &#172; List.member l x&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="">      </span><span class="keyword1">then</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="">z</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;l = []&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="">      </span><span class="keyword1">then</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;r = []&quot;</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="alt_string">`l &#8776; r`</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">      </span><span class="keyword1">then</span><span class=""> </span><span class="keyword3">show</span><span class=""> </span><span class="var">?case</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">z</span><span class=""> </span><span class="">list_eq2_refl</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">    </span><span class="keyword1">next</span><span class="">
</span><span class="">      </span><span class="keyword3">case</span><span class=""> </span><span class="delimiter">(</span><span class="">Suc</span><span class=""> </span><span class="">m</span><span class="delimiter">)</span><span class="">
</span><span class="">      </span><span class="keyword1">have</span><span class=""> </span><span class="">b</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;l &#8776; r&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">fact</span><span class="">
</span><span class="">      </span><span class="keyword1">have</span><span class=""> </span><span class="">d</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;card_list l = Suc m&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">fact</span><span class="">
</span><span class="">      </span><span class="keyword1">then</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;&#8707;a. List.member l a&quot;</span><span class=""> 
</span><span class="">        </span><span class="keyword1"><span class="improper">apply</span></span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">        </span><span class="keyword1"><span class="improper">apply</span></span><span class="delimiter">(</span><span class="">drule</span><span class=""> </span><span class="">card_eq_SucD</span><span class="delimiter">)</span><span class="">
</span><span class="">        </span><span class="keyword1"><span class="improper">apply</span></span><span class="delimiter">(</span><span class="">blast</span><span class="delimiter">)</span><span class="">
</span><span class="">        </span><span class="keyword1"><span class="improper">done</span></span><span class="">
</span><span class="">      </span><span class="keyword1">then</span><span class=""> </span><span class="keyword3">obtain</span><span class=""> </span><span class="">a</span><span class=""> </span><span class="keyword2">where</span><span class=""> </span><span class="">e</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;List.member l a&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="">      </span><span class="keyword1">then</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="">e&#39;</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;List.member r a&quot;</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">list_eq_def</span><span class=""> </span><span class="delimiter">[</span><span class="">simplified</span><span class=""> </span><span class="">List.member_def</span><span class=""> </span><span class="delimiter">[</span><span class="">symmetric</span><span class="delimiter">]</span><span class="delimiter">,</span><span class=""> </span><span class="">of</span><span class=""> </span><span class="">l</span><span class=""> </span><span class="">r</span><span class="delimiter">]</span><span class=""> </span><span class="">b</span><span class=""> 
</span><span class="">        </span><span class="keyword1">by</span><span class=""> </span><span class="">auto</span><span class="">
</span><span class="">      </span><span class="keyword1">have</span><span class=""> </span><span class="">f</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;card_list (removeAll a l) = m&quot;</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">e</span><span class=""> </span><span class="">d</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">simp</span><span class="delimiter">)</span><span class="">
</span><span class="">      </span><span class="keyword1">have</span><span class=""> </span><span class="">g</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;removeAll a l &#8776; removeAll a r&quot;</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">remove_fset.rsp</span><span class=""> </span><span class="">b</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">      </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;(removeAll a l) &#8776;2 (removeAll a r)&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">Suc.hyps</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">f</span><span class=""> </span><span class="">g</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">      </span><span class="keyword1">then</span><span class=""> </span><span class="keyword1">have</span><span class=""> </span><span class="">h</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;(a # removeAll a l) &#8776;2 (a # removeAll a r)&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">list_eq2.intros</span><span class="delimiter">(</span><span class="">5</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="">
</span><span class="">      </span><span class="keyword1">have</span><span class=""> </span><span class="">i</span><span class="delimiter">:</span><span class=""> </span><span class="string">&quot;l &#8776;2 (a # removeAll a l)&quot;</span><span class="">
</span><span class="">        </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">list_eq2.intros</span><span class="delimiter">(</span><span class="">3</span><span class="delimiter">)</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">member_delete_list_eq2</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">e</span><span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">      </span><span class="keyword1">have</span><span class=""> </span><span class="string">&quot;l &#8776;2 (a # removeAll a r)&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">rule</span><span class=""> </span><span class="">list_eq2.intros</span><span class="delimiter">(</span><span class="">6</span><span class="delimiter">)</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">i</span><span class=""> </span><span class="">h</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">      </span><span class="keyword1">then</span><span class=""> </span><span class="keyword3">show</span><span class=""> </span><span class="var">?case</span><span class=""> </span><span class="keyword1">using</span><span class=""> </span><span class="">list_eq2.intros</span><span class="delimiter">(</span><span class="">6</span><span class="delimiter">)</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">_</span><span class=""> </span><span class="">member_delete_list_eq2</span><span class="delimiter">[</span><span class="">OF</span><span class=""> </span><span class="">e&#39;</span><span class="delimiter">]</span><span class="delimiter">]</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">simp</span><span class="">
</span><span class="">    </span><span class="keyword1">qed</span><span class="">
</span><span class="">    </span><span class="keyword1">}</span><span class="">
</span><span class="">  </span><span class="keyword1">then</span><span class=""> </span><span class="keyword3">show</span><span class=""> </span><span class="string">&quot;l &#8776; r &#10233; l &#8776;2 r&quot;</span><span class=""> </span><span class="keyword1">by</span><span class=""> </span><span class="">blast</span><span class="">
</span><span class="keyword1">qed</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="comment">(* We cannot write it as &quot;assumes .. shows&quot; since Isabelle changes
   the quantifiers to schematic variables and reintroduces them in
   a different order *)</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">fset_eq_cases</span><span class="delimiter">:</span><span class="">
</span><span class=""> </span><span class="string">&quot;&#10214;a1 = a2;
   &#8896;a b xs. &#10214;a1 = insert_fset a (insert_fset b xs); a2 = insert_fset b (insert_fset a xs)&#10215; &#10233; P;
   &#10214;a1 = {||}; a2 = {||}&#10215; &#10233; P; &#8896;xs ys. &#10214;a1 = ys; a2 = xs; xs = ys&#10215; &#10233; P;
   &#8896;a xs. &#10214;a1 = insert_fset a (insert_fset a xs); a2 = insert_fset a xs&#10215; &#10233; P;
   &#8896;xs ys a. &#10214;a1 = insert_fset a xs; a2 = insert_fset a ys; xs = ys&#10215; &#10233; P;
   &#8896;xs1 xs2 xs3. &#10214;a1 = xs1; a2 = xs3; xs1 = xs2; xs2 = xs3&#10215; &#10233; P&#10215;
  &#10233; P&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">lifting</span><span class=""> </span><span class="">list_eq2.cases</span><span class="delimiter">[</span><span class="">simplified</span><span class=""> </span><span class="">list_eq2_equiv</span><span class="delimiter">[</span><span class="">symmetric</span><span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">lemma</span><span class=""> </span><span class="">fset_eq_induct</span><span class="delimiter">:</span><span class="">
</span><span class="">  </span><span class="keyword2">assumes</span><span class=""> </span><span class="string">&quot;x1 = x2&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class=""> </span><span class="string">&quot;&#8896;a b xs. P (insert_fset a (insert_fset b xs)) (insert_fset b (insert_fset a xs))&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class=""> </span><span class="string">&quot;P {||} {||}&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class=""> </span><span class="string">&quot;&#8896;xs ys. &#10214;xs = ys; P xs ys&#10215; &#10233; P ys xs&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class=""> </span><span class="string">&quot;&#8896;a xs. P (insert_fset a (insert_fset a xs)) (insert_fset a xs)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class=""> </span><span class="string">&quot;&#8896;xs ys a. &#10214;xs = ys; P xs ys&#10215; &#10233; P (insert_fset a xs) (insert_fset a ys)&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">and</span><span class=""> </span><span class="string">&quot;&#8896;xs1 xs2 xs3. &#10214;xs1 = xs2; P xs1 xs2; xs2 = xs3; P xs2 xs3&#10215; &#10233; P xs1 xs3&quot;</span><span class="">
</span><span class="">  </span><span class="keyword2">shows</span><span class=""> </span><span class="string">&quot;P x1 x2&quot;</span><span class="">
</span><span class="">  </span><span class="keyword1">using</span><span class=""> </span><span class="">assms</span><span class="">
</span><span class="">  </span><span class="keyword1">by</span><span class=""> </span><span class="delimiter">(</span><span class="">lifting</span><span class=""> </span><span class="">list_eq2.induct</span><span class="delimiter">[</span><span class="">simplified</span><span class=""> </span><span class="">list_eq2_equiv</span><span class="delimiter">[</span><span class="">symmetric</span><span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword1">ML</span><span class=""> </span><span class="verbatim">{*
fun dest_fsetT (Type (@{type_name fset}, [T])) = T
  | dest_fsetT T = raise TYPE (&quot;dest_fsetT: fset type expected&quot;, [T], []);
*}</span><span class="">
</span><span class="">
</span><span class="keyword1">no_notation</span><span class="">
</span><span class="">  </span><span class="">list_eq</span><span class=""> </span><span class="delimiter">(</span><span class="keyword2">infix</span><span class=""> </span><span class="string">&quot;&#8776;&quot;</span><span class=""> </span><span class="">50</span><span class="delimiter">)</span><span class=""> </span><span class="keyword2">and</span><span class=""> 
</span><span class="">  </span><span class="">list_eq2</span><span class=""> </span><span class="delimiter">(</span><span class="keyword2">infix</span><span class=""> </span><span class="string">&quot;&#8776;2&quot;</span><span class=""> </span><span class="">50</span><span class="delimiter">)</span><span class="">
</span><span class="">
</span><span class="keyword2">end</span><span class="">
</span></pre>

</div>
</body>
</html>
